<div class="scroll-container">
  <mat-toolbar>
    <button mat-icon-button [routerLink]="['/']" style="margin-right: 8px;">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <span>{{ existingForm ? 'Editare' : 'Adăugare'}} P.V.</span>
    <span class="spacer"></span>
    @if(existingForm) {
      <button mat-icon-button matTooltip="Ștergeți P.V." (click)="deleteForm()">
        <mat-icon>delete</mat-icon>
      </button>
    }
    <button mat-icon-button matTooltip="Salvați P.V." (click)="saveForm()">
      <mat-icon>save</mat-icon>
    </button>
  </mat-toolbar>
  <div class="scroll">
    <app-loading-screen [active]="loading"></app-loading-screen>
    @if(formGroup) {
      <form [formGroup]="formGroup">
        <mat-card class="form-edit-card mat-elevation-z2">
          <mat-card-header>
            <mat-card-title>
              Proces-verbal pentru {{ election.type.name }} - {{ poll.name }}
              @if(precinct) {
                (SV {{ precinct.number }})
              }
            </mat-card-title>
            <mat-card-subtitle [class]="formGroup.invalid ? 'invalid' : 'valid'">
              Procesul-verbal este {{formGroup.invalid ? 'invalid' : 'valid'}}.
            </mat-card-subtitle>
            <span class="spacer"></span>
            @if(election.type.formStructure.simpvPullStrategy) {
              <button mat-icon-button matTooltip="Autocompletați date din SIMPV" (click)="autocompleteFromSimpv()">
                <mat-icon>cloud_download</mat-icon>
              </button>
            }
          </mat-card-header>
        </mat-card>
        @for(section of election.type.formStructure.sections; track $index) {
          <mat-card class="form-edit-card mat-elevation-z2">
            <mat-card-header>
              <mat-card-title>{{ section.title }}</mat-card-title>
              <mat-card-subtitle>{{ section.subtitle }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              @for(field of section.fields; track field.id) {
                <mat-form-field>
                  <mat-label>
                    {{ field.title }} {{ field.type === 'computed' ? '| Se completează automat' : ''}}
                  </mat-label>
                  <input
                    matInput
                    [formControlName]="field.id"
                    [errorStateMatcher]="matcher"
                    placeholder=""
                    type="number"
                    min="0"
                    inputmode="numeric"
                    pattern="[0-9]*"
                    [readonly]="field.type === 'computed'"
                  />
                  <mat-hint>{{ field.hint }}</mat-hint>
                  @if(formGroup.get(field.id).errors?.['negative']) {
                    <mat-error>Numărul nu poate fi negativ!</mat-error>
                  } @else {
                    <mat-error>{{ getFieldCrossErrorDescription(field.id) }}</mat-error>
                  }
                </mat-form-field>
              }
            </mat-card-content>
          </mat-card>
        }
        <mat-card class="form-edit-card mat-elevation-z2">
          <mat-card-header>
            <mat-card-title>Voturi valabil exprimate pentru fiecare candidat</mat-card-title>
            <mat-card-subtitle>Numărați voturile valabil exprimate pentru fiecare candidat în parte (punctul h.)</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            @for(candidate of candidates; track $index) {
              <mat-form-field>
                <mat-label>
                  h{{ $index + 1 }}. {{ candidate.candidate }} {{ candidate.party ? '(' + candidate.party + ')' : '' }}
                </mat-label>
                <input
                  matInput
                  [formControlName]="election.type.formStructure.candidateSectionKey + ($index + 1)"
                  [errorStateMatcher]="matcher"
                  placeholder=""
                  type="number"
                  min="0"
                  inputmode="numeric"
                  pattern="[0-9]*"
                />
                <mat-error>Numărul nu poate fi negativ!</mat-error>
              </mat-form-field>
            }
          </mat-card-content>
        </mat-card>
      </form>
    }
  </div>
</div>
